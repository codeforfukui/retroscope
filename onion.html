

<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<title>Retroscope - Onion</title>
<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0" />
<link rel="stylesheet"
	href="//cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
<script src="//cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
<style>
body {
	width: 100%;
	height: 100%;
	overflow: hidden;
}

#map {
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
}
</style>
</head>
<body>
	<div id="map">
		<a href="http://cyberjapandata.gsi.go.jp/xyz/gazo1/{z}/{x}/{y}.jpg"
			class="tile" data-minZoom="10" data-maxZoom="17">国土画像情報（第一期：1974～1978年撮影）</a>
		<a href="http://cyberjapandata.gsi.go.jp/xyz/gazo2/{z}/{x}/{y}.jpg"
			class="tile" data-minZoom="15" data-maxZoom="17" data-radius="400">国土画像情報（第二期：1979～1983年撮影）</a>
		<a href="http://cyberjapandata.gsi.go.jp/xyz/gazo3/{z}/{x}/{y}.jpg"
			class="tile" data-minZoom="15" data-maxZoom="17" data-radius="300">国土画像情報（第三期：1984～1986年撮影）</a>
		<a href="http://cyberjapandata.gsi.go.jp/xyz/gazo4/{z}/{x}/{y}.jpg"
			class="tile" data-minZoom="15" data-maxZoom="17" data-radius="200">国土画像情報（第四期：1988～1990年撮影）</a>
		<a href="http://cyberjapandata.gsi.go.jp/xyz/ort/{z}/{x}/{y}.jpg"
			class="tile" data-minZoom="10" data-maxZoom="17" data-radius="100">電子国土基本図（オルソ画像）</a>
	</div>

	<script>
		var RoundTileLayer = L.TileLayer.extend({
			onAdd : function(map) {
				L.TileLayer.prototype.onAdd.call(this, map);
				var e = this.getContainer();
				var o = this.options;
				var r = o.radius || 200;

				e.style.overflow = "hidden";
				e.style.top = "0";
				e.style.left = "0";
				e.style.width = (r * 2) + "px";
				e.style.height = (r * 2) + "px";
				e.style.borderRadius = r + "px";
				e.style.border = "2px solid black";
				e.style.transform = "translate3d(-1000px,-1000px,0)";

				map.on("zoomend", function(event) {
					var z = map.getZoom();
					var f = (z < o.minZoom || o.maxZoom < z);
					e.style.display = (f ? "none" : "block");
				});
			},
			setCenter : function(p) {
				var e = this.getContainer();
				var r = this.options.radius || 200;
				var x = p.x - r;
				var y = p.y - r;
				e.style.transform = "translate3d(" + x + "px," + y + "px,0)";
				var t = "translate3d(" + (-x) + "px," + (-y) + "px,0)";
				for (var f = e.firstChild; f != null; f = f.nextSibling)
					if (f.style)
						f.style.transform = t;
			}
		});

		var layers = [];
		var as = document.querySelectorAll("a.tile");
		Array.prototype.slice.call(as).forEach(function(a, i) {
			var href = null;
			var opt = {
				attribution : a.textContent
			};
			Array.prototype.slice.call(a.attributes).forEach(function(b, j) {
				if (b.name == "href")
					href = b.value;
				else if (b.name.match(/^data-(.*)$/))
					opt[RegExp.$1] = b.value;
			});
			if (i == 0)
				layers.push(L.tileLayer(href, opt));
			else
				layers.push(new RoundTileLayer(href, opt));
			a.parentNode.removeChild(a);
		});

		L.map("map", {
			zoom : 15,
			center : [ 35.638604, 139.889088 ],
			layers : layers
		}).on("mousemove", function(event) {
			var p = event.layerPoint;
			layers.forEach(function(a, i) {
				if (a.setCenter)
					a.setCenter(p);
			});
		});
	</script>
</body>
</html>

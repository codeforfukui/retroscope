<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<title>Retroscope</title>
<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0" />
<link rel="stylesheet" href="//cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
<script src="//cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
<script src="//cdn.rawgit.com/mlevans/leaflet-hash/master/leaflet-hash.js"></script>
<style>
body {
	width: 100%;
	height: 100%;
	overflow: hidden;
}

#map {
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
}

svg {
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	pointer-events: none;
}

.leaflet-layer {
	visibility: hidden;
}

.leaflet-layer:first-child {
	visibility: visible;
}
</style>
</head>
<body>
	<div id="map"></div>
	<svg xmlns="http://www.w3.org/2000/svg">
		<defs>
			<filter id="e1" filterUnits="userSpaceOnUse">
				<feGaussianBlur in="SourceGraphic" stdDeviation="25" />
			</filter>
			<mask id="e2" maskUnits="userSpaceOnUse">
				<g filter="url(#e1)">
					<circle cx="0" cy="0" r="300" fill="none" id="e3" />
					<circle cx="0" cy="0" r="200" fill="white" id="e4" />
				</g>
			</mask>
			<g id="e5" />
		</defs>
		<g mask="url(#e2)">
			<use xlink:href="#e5" x="0" y="0" id="e6" />
		</g>
	</svg>
	<script>
		var bg = L.tileLayer('http://cyberjapandata.gsi.go.jp/xyz/ort/{z}/{x}/{y}.jpg', {
			attribution : '<a href="http://maps.gsi.go.jp/development/">地理院タイル・オルソ画像(国土地理院)</a>'
		});

		var fg = L.tileLayer('http://www.finds.jp/ws/tmc/1.0.0/Kanto_Rapid-900913-L/{z}/{x}/{y}.png', {
			attribution : '<a href="http://habs.dc.affrc.go.jp/">歴史的農業環境閲覧システム(NIAES)</a>'
		});

		if (location.search.match(/^\?kjmapw,([a-z_0-9]+\/[a-z_0-9]+)$/))
			fg = L.tileLayer('http://ktgis.net/kjmapw/kjtilemap/' + RegExp.$1 + '/{z}/{x}/{y}.png', {
				attribution : '<a href="http://ktgis.net/kjmapw/">今昔マップ on the web</a>',
				tms : true
			});

		var e3 = document.getElementById("e3");
		var e4 = document.getElementById("e4");
		var e5 = document.getElementById("e5");
		var e6 = document.getElementById("e6");
		var cx = window.innerWidth * 0.5;
		var cy = window.innerHeight * 0.5;
		e3.setAttribute("cx", cx);
		e3.setAttribute("cy", cy);
		e4.setAttribute("cx", cx);
		e4.setAttribute("cy", cy);

		var opt = L.Hash.parseHash(location.hash) || {
			zoom : 15,
			center : [ 35.670685, 139.785233 ]
		};
		opt.maxZoom = 16;
		opt.minZoom = 8;

		var map = L.map("map", opt).on("move", function(e) {
			var p = map.containerPointToLayerPoint([ 0, 0 ]);
			e6.setAttribute("x", -p.x);
			e6.setAttribute("y", -p.y);
		}).on("mousemove", function(e) {
			var p = e.containerPoint;
			e3.setAttribute("cx", p.x);
			e3.setAttribute("cy", p.y);
			e4.setAttribute("cx", p.x);
			e4.setAttribute("cy", p.y);
		}).on("viewreset", function(e) {
			while (e5.firstChild)
				e5.removeChild(e5.firstChild);
		});
		map.zoomControl.setPosition("bottomright");

		new L.Hash(map);

		bg.addTo(map);

		fg.on("tileload", function(e) {
			var p = L.DomUtil.getPosition(e.tile);
			var img = document.createElementNS("http://www.w3.org/2000/svg", "image");
			img.setAttributeNS("http://www.w3.org/1999/xlink", "href", e.url);
			img.setAttribute("width", 256);
			img.setAttribute("height", 256);
			img.setAttribute("x", p.x);
			img.setAttribute("y", p.y);
			e.tile.img = img;
			e5.appendChild(img);
		}).on("tileunload", function(e) {
			var img = e.tile.img;
			if (img && img.parentNode)
				img.parentNode.removeChild(img);
		}).addTo(map);
	</script>
</body>
</html>
